<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>CS 448B Assignment 3</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoibWhhcnRlbm9yaW8iLCJhIjoiY2xkeXh0MzRnMG9tdjNwb3ZzdmI5aDlxbCJ9.QeyPN0ZvTHLHTH4oDqFx6g";
    var map;
    const data = d3
      .csv(
        "https://raw.githubusercontent.com/mhartenorio/sf-restaurants-js/main/asst3_yelp.csv",
        function (d) {
          let coordinates = d.coordinates;
          let coordArr = coordinates.split(",");
          coordArr[0] = parseFloat(coordArr[0]);
          coordArr[1] = parseFloat(coordArr[1]);
          d.coordinates = coordArr.reverse();
          //console.log(d)
          return d;
        }
      )
      .then(createMap)
      .then(createDots);

    function createMap(data) {
      map = new mapboxgl.Map({
        container: "map", // container id
        style: "mapbox://styles/mapbox/light-v9", // stylesheet location
        zoom: 9, // starting zoom
        center: [-122.0739, 37.6955],
        //interactive: false,
      });

      map.on("viewreset", render);
      map.on("move", render);
      map.on("moveend", render);

      // Optional: Modify map with d3
      d3.selectAll(".mapboxgl-canvas")
        .style("opacity", 1)
        .style("position", "absolute")
        .style("z-index", 1);
      return data;
    }

    function createDots(data) {
      var container = map.getCanvasContainer();
      //let coordinates = data.map(d => d.coordinates);
      // console.log(coordinates)
      // console.log(data)
      var svg = d3
        .select(container)
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100vh")
        // Ensure d3 layer in front of map
        .style("position", "absolute")
        .style("z-index", 10);

      let dots = svg
        .selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("class", "circle")
        .attr("r", 5)
        .style("opacity", 0.7)
        .style("fill", "black");

      render();
    }

    // Projection method:
    // Project geojson coordinate to the map's current state
    function project(d) {
      return map.project(new mapboxgl.LngLat(d[0], d[1]));
    }

    // Render method redraws lines
    function render() {
      d3.selectAll(".circle")
        .attr("cx", function (d) {
          return project(d.coordinates).x;
        })
        .attr("cy", function (d) {
          return project(d.coordinates).y;
        });
    }
  </script>
</body>

</html>